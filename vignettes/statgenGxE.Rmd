---
title: "Genotype by Environment analysis using statgenGxE"
author: "Bart-Jan van Rossum"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: false
    number_sections: true
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{Genotype by Environment analysis using statgenGxE}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>",
fig.dim = c(7, 4)
)
library(statgenGxE)
## Call requireNamespace here to prevent license output in first call in vignette.
requireNamespace("asreml", quietly = TRUE)
options(width = 90, digits = 2)
```

# The statgenGxE package

The statgenGxE package is developed as an easy-to-use package for Genotype by Environment (GxE) analysis of data of plant breeding experiments with many options for plotting and reporting the results of the analyses.  

This vignette describes in detail how to perform the different types of analysis that are available in the package. The availability of functions in the package is mainly based on the analyses described in @vanEeuwijk2016.

The following types of analysis can be done using statgenGxE:

* [Mixed model Analysis](#vc)
* [AMMI Analysis](#am)
* [GGE Analysis](#gge)
* [Finlay-Wilkinson Analysis](#fw)
* [Identification of mega environments](#me)
* [Computation of stability measures](#st)

---

## Data preparation

The use of the package is demonstrated using maize data from the European Union project DROPS. The data is available from https://data.inra.fr/dataset.xhtml?persistentId=doi:10.15454/IASSTN [@Millet2019] and the relevant data set is included as data.frame in the statgenGxE package.

The first step is loading the data into R. 
```{r loadData} 
data(dropsPheno)
```
dropsPheno contains data for the genotypic means (Best Linear Unbiased Estimators, BLUEs), with one value per experiment per genotype, for a selection of 10 experiments from the full data set and eight traits. These 10 experiments form a good representation of the full set of experiments covering the five scenarios described in @Millet2016. For a more detailed description of the contents of the data see `help(dropsData)`.

The input for GxE analysis in the statgenGxE package is an object of class TD (Trial Data). For a detailed description on how to construct such an object see the vignette of the statgenSTA package (`vignette("Modeling field trials using statgenSTA")`). For GxE analysis, only specifying the columns in the data containing genotype and trial is usually enough. This is also the case for dropsPheno.

```{r createTD}
## Create a TD object from dropsPheno
dropsTD <- createTD(data = dropsPheno, genotype = "Variety_ID", trial = "Experiment")
```

Before doing any analysis, we can first have a look at the contents of the data. To do this a box plot can be made. Coloring the boxes by scenario will provide valuable extra information.

```{r TDbox}
## Create a box plot of dropsTD
## Color the boxes based on the variable scenarioFull.
## Plot in  descending order.
plot(dropsTD, plotType = "box", traits = "grain.yield", colorBy = "scenarioFull", 
     orderBy = "descending")
```

From the plot it is clear that the trials in the hot, water deficit environments have a lower mean and variance than the other trials.

## Mixed model analysis {#vc}

The function `gxeVarComp` allows to fit linear mixed models of diverse complexity. Models can be fitted using either lme4 [@Bates2015] or asreml [@Gilmour2017] as modeling engine. If the engine is set to 'lme4', only a model considering multiple variance components, but with a compound symmetry variance-covariance structure can be fitted. If the engine is set to 'asreml', complex variance-covariance structures will be fitted sequencially to the genotype by environment data. The best fitting model is then identified. The selection of the best variance-covariance model considers the following variance-covariance structures:

* identity
* compound symmetry (cs)
* diagonal
* heterogeneous compound symmetry (hcs)
* simple correlation with heterogeneous variance (outside)
* first order factor analytic (fa)
* second order factor analytic (fa2)
* unstructured

The best model for the data is selected based on either the Akaike Information Criterion (AIC [@Akaike1974]) or the Baysian Information Criterion (BIC [@Schwarz1978]). Which criterion is used is determined by the parameter `criterion` in the function `gxeVarComp`.  

```{r geVClme}
## Use lme4 for fitting the models - only compound symmetry.
dropsVC <- gxeVarComp(TD = dropsTD, trait = "grain.yield")
summary(dropsVC)
```

```{r geVCasreml}
## Use asreml for fitting the models - eight models fitted. 
## Use AIC as criterion for determining the best model.
if (requireNamespace("asreml", quietly = TRUE)) {
  dropsVC2 <- gxeVarComp(TD = dropsTD, trait = "grain.yield", engine = "asreml",
                         criterion = "AIC")
  summary(dropsVC2)
}
```
`r if (exists("dropsVC2")) {"As becomes clear from the summary, the best model based on AIC is the model with an unstructured variance-covariance structure."  }` 

*Note that for both factor analytic models to be fitted a minimum of five environments is needed. If the data contains less environments, those two models are skipped.*

A heat map of the covariance and correlation between the environments based on the best fitted model can be plotted. 

```{r geVCPlot}
if (requireNamespace("asreml", quietly = TRUE)) {
  plot(dropsVC2)
}
```
  
The upper left of the plot displays the covariance between environments. Larger values are displayed in a bigger font. In the lower right of the plot correlations between environments are shown. A dark red color indicates a strong positive correlation between environments, a dark blue color a strong negative correlation. Environments are clustered by their correlations and ordered according to the results of the clustering.

A pdf report containing the most important results of the analysis can be made using the `report` function.
```{r geVCRep, eval=FALSE}
report(dropsVC2, outfile = "./myReports/varCompReport.pdf")
```

## AMMI Analysis {#am}

The Additive Main Effects and Multiplicative Interaction (AMMI) model fits a model which involves the Additive Main effects (i.e. genotype and trial) along with the Multiplicative Interaction effects. Then a principal component analysis is done on the residuals (multiplicative interaction). This results in an interaction characterized by Interaction Principal Components (IPCA) enabling simultaneous plotting of genotypes and trials.  

The AMMI analysis can be performed with the statgenGxE package using the function `gxeAmmi`. 
```{r geAmmi}
## Run gxeAmmi with default settings.
dropsAm <- gxeAmmi(TD = dropsTD, trait = "grain.yield")
summary(dropsAm)
```
With the default settings in the principal components analysis a maximum of two principal components are used. This can be changed using the parameter `nPC` in the function. The number of principal components can never be larger than the number of environments and the number of genotypes in the data. By specifying `nPC = NULL` the algorithm will determine the number of principal components by a method of forward selection.
```{r geAmmi2}
## Run gxeAmmi. Let algorithm determine number of principal components.
dropsAm2 <- gxeAmmi(TD = dropsTD, trait = "grain.yield", nPC = NULL)
summary(dropsAm2)
```
From the summary it is clear that the final number of principal components, determined by forward selection, is 7.

It is possible to exclude certain genotypes, e.g. outliers, from the analysis using the parameter `excludeGeno`.

```{r geAmmi3}
## Run gxeAmmi with three principal components.
## Exclude genotypes 11430 and A3.
dropsAm3 <- gxeAmmi(TD = dropsTD, trait = "grain.yield", nPC = 3, 
                    excludeGeno = c("11430", "A3"))
```
If the data contains a column year, it is possible to fit a separate AMMI model for each year. This can be done by specifying the parameter `byYear = TRUE`.  This will run an AMMI analysis for all years in the data without taking into account the data for the other years. 
```{r geAmmiYear}
## Run gxeAmmi per year in the data.
dropsAmYear <- gxeAmmi(TD = dropsTD, trait = "grain.yield", byYear = TRUE)
```

The results of an AMMI analysis can be displayed in a biplot. Two types of biplot are available. "AMMI1" plots the main effects against the first principal component. "AMMI2" plots the first against the second principal component.
```{r plotAmmi1, fig.width=5, fig.height=5, out.width="75%"}
## Create an AMMI1 and AMMI2 biplot.
plot(dropsAm, scale = 0.5, plotType = "AMMI1")
```
```{r plotAmmi2, fig.width=5, fig.height=5, out.width="75%"}
## Create an AMMI1 and AMMI2 biplot.
plot(dropsAm, scale = 0.5, plotType = "AMMI2")
```

The AMMI plot function has many options to customize the plot. It is possible to plot different principal components on the axes specifying `primAxis` and `secAxis`.  
Genotypes can be grouped and colored by a variable in the data using `colorGenoBy`. Specify custom colors in `colGeno`. Similarly for coloring environments use `colorEnvBy` and `colEnv`.
```{r plotAmmiCol, fig.width=5, fig.height=5, out.width="75%"}
## Create an AMMI2 biplot.
## Color genotypes based on variable genetic_group. Use custom colors.
## Color environments base on variable scenarioFull
plot(dropsAm, scale = 0.4, plotType = "AMMI2", 
     colorGenoBy = "genetic_group", colGeno = c("red", "blue", "green", "yellow"),
     colorEnvBy = "scenarioFull")

```

A convex hull can be plotted around the genotypes in an AMMI2 biplot with lines from the origin perpendicular to the edges of the hull. This is useful for identifying mega environments. 
```{r plotAmmiConvHull, fig.width=5, fig.height=5, out.width="75%"}
## Create an AMMI2 biplot with convex hull around the genotypes.
plot(dropsAm, scale = 0.4, plotType = "AMMI2", plotConvHull = TRUE, colorEnvBy = "scenarioFull")

```

Genotypes can be left out of the plot completely by setting `plotGeno = FALSE` and similarly `plotEnv = FALSE` assures no environments are plotted. For displaying genotypes by their names instead of points, use `sizeGeno` with a size larger than zero to indicate their text size. `envFactor` can be used to blow up the environmental scores in the plot. A value for `envFactor` between zero and one effectively blows up the genotypic scores. See `help(plot.AMMI)` for full details on all plotting options.

For the AMMI analysis a report can be made using the `report` function.
```{r geAMMIRep, eval=FALSE}
report(dropsAm, outfile = "./myReports/AMMIReport.pdf")
```

## GGE Analysis {#gge}

A Genotype plus Genotype by Environment analysis is very similar to an AMMI analysis. The difference is in the first step where, instead of genotype and environment, only environment is fitted as a main effect in the model. Therefore, the principal component analysis is performed on the genotype main effect and the interaction jointly. The GGE analysis is done in statgenGxE by running the function `gxeAmmi` with parameter
`GGE = TRUE`.

```{r geGGE}
## Run gxeAmmi with default settings.
dropsGGE <- gxeAmmi(TD = dropsTD, trait = "grain.yield", GGE = TRUE)
summary(dropsGGE)
```

Options for plotting results of a GGE analysis are identical to those for an AMMI analysis.
`plotType` "GGE1" and "GGE2" may be used as substitutes for "AMMI1" and "AMMI2", but the latter are valid options as well.
```{r plotGGE, fig.width=5, fig.height=5, out.width="75%"}
## Create an GGE1 and GGE2 biplot.
plot(dropsGGE, scale = 0.5, plotType = "GGE2", plotConvHull = TRUE)
```

## Finlay-Wilkinson Analysis {#fw}

With the Finlay-Wilkinson Analysis [@Finlay1963] a modified joint regression analysis is used to rank genotypes based on phenotypic stability for each individual trait.  

In the statgenGxE package this analysis can be done using the `gxeFW` function. By default all trials in the `TD` object are used in the analysis, but this can be restricted using the parameter `trials`. The genotypes included in the analysis can be restricted using `genotypes`.
```{r geFW}
## Perform a Finlay-Wilkinson analysis for all trials.
dropsFW <- gxeFw(TD = dropsTD, trait = "grain.yield")
summary(dropsFW)
```
Three types of plots can be made to investigate the output of the analysis. `plotType = "scatter"` creates three scatter plots where genotypic mean, mean squared deviation and sensitivity are plotted against each other. `plotType = "line"` creates a plot with fitted lines for all genotypes in the analysis. `plotType = "trellis"` creates a trellis plot with individual slopes per genotype. At most 64 genotypes are plotted. It is possible to select genotypes using the parameter `genotypes`.
```{r plotFW,fig.width=5,fig.height=5,fig.show="hold"}
## Create three types of plots for Finlay Wilkinson analysis.
## Restrict trellis plot to first 5 genotypes.
plot(dropsFW, plotType = "scatter")
plot(dropsFW, plotType = "line")
plot(dropsFW, plotType = "trellis", genotypes = c("11430", "A3", "A310", "A347", "A374"))
```
  
A report can be made as well containing a summary of the analysis.
```{r geFWRep, eval=FALSE}
report(dropsFW, outfile = "./myReports/FWReport.pdf")
```

## Computation of mega environments {#me}

For the computation of mega environments, an AMMI model is fitted and then, using the fitted values from this model, the environments are clustered.
Mega environments are created by grouping environments based on their best performing genotype. Environments that share the same best genotype belong to the same mega environment, regardless whether environments correspond to years or locations.  
```{r geMegaEnv}
## Compute mega environments.
dropsMegaEnv <- gxeMegaEnv(TD = dropsTD, trait = "grain.yield")
```
As can be seen in the column Mega factor in the output, four mega environments have been created, one for each of the winning genotypes "Lo1087", "Lo1251", "Lo1270" and "PHG35".

The values for the Best Linear Unbiased Predictors (BLUPs) and associated standard errors for the genotypes based on the calculated mega environments, can be computed using the function `gxeTable`. This can be done using either "asreml" or "lme4" as an engine for fitting the model.

```{r geMegaEnvPred}
if (requireNamespace(package = "asreml", quietly = TRUE)) {
  ## Compute BLUPs.
  ## Use asreml as engine for fitting model.
  geMegaEnvPred <- gxeTable(TD = dropsMegaEnv, trait = "grain.yield", engine = "asreml")
  head(geMegaEnvPred$predictedValue)
}
```

## Computation of stability measures {#st}

Different measures of stability can be calculated using the statgenGxE package, the cultivar-superiority measure of Lin & Binns [@Lin1988], Shukla's stability variance [@Shukla1972] and Wricke's ecovalence [@Wricke1962].

The cultivar-superiority measure is the sum of the squares of the difference between genotypic mean in each environment and the mean of the best genotype, divided by twice the number of environments. Genotypes with the smallest values of the superiority tend to be more stable, and closer to the best genotype in each environment.

Shukla's stability variance (static stability) is defined as the variance around the genotype's phenotypic mean across all environments. This provides a measure of the consistency of the genotype, without accounting for performance.

Wricke's Ecovalence Stability Coefficient is the contribution of each genotype to the GxE sum of squares, in an unweighted analysis of the GxE means. A low value indicates that the genotype responds in a consistent manner to changes in environment; i.e. is stable from a dynamic point of view. Like static stability, the Wricke's Ecovalence does not account for genotype performance.

To compute the stabibility measures use `gxeStability`. This will compute all three stability measures described above. This can be restricted by specifying one or more measure in `method`.

```{r geStab}
## Compute stability measures for dropsTD.
dropsStab <- gxeStability(TD = dropsTD, trait = "grain.yield")
## In the summary print the top two percent of the genotypes.
summary(dropsStab, pctGeno = 2)
```
Plotting the results yields a scatter plot for each stability measure, plotted against the genotypic mean.
```{r plotStab}
plot(dropsStab)
```

For the computation of stability measures a summary report can be made.
```{r geStabRep, eval=FALSE}
report(dropsStab, outfile = "./myReports/stabReport.pdf")
```

It is possible to calculate the stability measures based on mega environments instead of regular environments. To do so the parameter `useMegaEnv` has to be set to `TRUE`.
```{r geStabMegaEnv}
## Compute stability measures based on mega environments computed in the 
## previous paragraph.
dropsStabME <- gxeStability(TD = dropsMegaEnv, trait = "grain.yield", useMegaEnv = TRUE)
summary(dropsStabME, pctGeno = 2)
```

----

## References
