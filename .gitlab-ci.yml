stages:
  - build
  - test

image: docker-registry.wur.nl/rossu027/r-verasreml:latest

before_script:
    ## Set NOT_CRAN to true to enable test under skip_on_cran.
  - echo 'Sys.setenv(NOT_CRAN="true")' > .Rprofile

R-release:
  stage: build
  allow_failure: false
  script:
    ## Install missing and outdated packages.
    - Rscript -e 'source(".gitlab-ci.R"); pkgsUpdate()'
    ## Build package.
    - R CMD build . --no-manual
    - PKG_FILE_NAME=$(ls -1t *.tar.gz | head -n 1)
    - R CMD check "${PKG_FILE_NAME}" --no-manual --as-cran
  after_script:
  - Rscript -e 'covr::package_coverage(Sys.getenv("CI_PROJECT_DIR"))'
  artifacts:
    when: always
    paths:
      - '*.Rcheck/*'
    expire_in: '1 month'

R-devel:
  stage: build
  image: docker-registry.wur.nl/rossu027/r-develasreml:latest
  allow_failure: true
  script:
    ## Install missing and outdated packages.
    - Rscriptdevel -e 'source(".gitlab-ci.R"); pkgsUpdate()'
    ## Build package.
    - Rdevel CMD build . --no-manual
    - PKG_FILE_NAME=$(ls -1t *.tar.gz | head -n 1)
    - Rdevel CMD check "${PKG_FILE_NAME}" --no-manual --as-cran
  artifacts:
    when: always
    paths:
      - '*.Rcheck/*'
    expire_in: '1 month'

