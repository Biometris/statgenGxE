# ==================================================================== #
# TITLE                                                                #
# Antimicrobial Resistance (AMR) Analysis                              #
#                                                                      #
# SOURCE                                                               #
# https://gitlab.com/msberends/AMR                                     #
#                                                                      #
# LICENCE                                                              #
# (c) 2019 Berends MS (m.s.berends@umcg.nl), Luz CF (c.f.luz@umcg.nl)  #
#                                                                      #
# This R package is free software; you can freely use and distribute   #
# it for both personal and commercial purposes under the terms of the  #
# GNU General Public License version 2.0 (GNU GPL-2), as published by  #
# the Free Software Foundation.                                        #
#                                                                      #
# This R package was created for academic research and was publicly    #
# released in the hope that it will be useful, but it comes WITHOUT    #
# ANY WARRANTY OR LIABILITY.                                           #
# Visit our website for more info: https://msberends.gitlab.io/AMR.    #
# ==================================================================== #

stages:
  - build
  - test

image: rocker/r-base

variables:
  R_LIBS_USER: "$CI_PROJECT_DIR/ci/lib"

before_script:
  ## cache apt.
  - export APT_DIR=$CI_PROJECT_DIR/.apt && export APT_STATE_LISTS=$APT_DIR/lists && export APT_CACHE_ARCHIVES=$APT_DIR/archives
  - printf "dir::state::lists    ${APT_STATE_LISTS};\ndir::cache::archives    ${APT_CACHE_ARCHIVES};\n" > /etc/apt/apt.conf
  - mkdir -p "${APT_STATE_LISTS}/partial" && mkdir -p "${APT_CACHE_ARCHIVES}/partial"
  ## install apt dependencies for packages.
  - apt-get update -qq
  - apt-get update && apt-get install -y libxml2-dev libssl-dev libcurl4-openssl-dev zlib1g-dev libglu1-mesa-dev libfreetype6-dev > /dev/null
  - apt-get update && apt-get install -y --no-install-recommends qpdf ghostscript > /dev/null
  ## install pandoc - needed for checking readme.
  - apt-get update && apt-get install -y pandoc > /dev/null
  ## cache R packages.
  - mkdir -p $R_LIBS_USER
  - echo 'R_LIBS_USER='$R_LIBS_USER > .Renviron
  ## set GITLAB_PAT.
  - echo 'GITLAB_PAT='$GITLAB_PAT >> .Renviron
  ## Set _R_CHECK_FORCE_SUGGESTS_ to FALSE so R check doesn't crash over asreml.
  - echo '_R_CHECK_FORCE_SUGGESTS_="false"' >> .Renviron

R-release:
  stage: build
  allow_failure: false
  script:
    - Rscript -e 'sessionInfo()'
    # install missing and outdated packages
    - Rscript -e 'source(".gitlab-ci.R"); pkgsUpdate(repos = "https://cran.rstudio.com", quiet = TRUE, instPkgdown = FALSE)'
    - Rscript -e 'remotes::install_gitlab(repo = "statistical-genetic-pipeline/statgenSSA", host = "git.wur.nl")'
    # remove vignettes folder and get VignetteBuilder field out of DESCRIPTION file
    - rm -rf vignettes
    - Rscript -e 'd <- read.dcf("DESCRIPTION"); d[, colnames(d) == "VignetteBuilder"] <- NA; write.dcf(d, "DESCRIPTION")'
    # build package
    - R CMD build . --no-build-vignettes --no-manual
    - PKG_FILE_NAME=$(ls -1t *.tar.gz | head -n 1)
    - R CMD check "${PKG_FILE_NAME}" --no-build-vignettes --no-manual --as-cran
  artifacts:
    when: always
    paths:
      - '*.Rcheck/*'
    expire_in: '1 month'
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - $R_LIBS_USER
      - $CI_PROJECT_DIR/.apt

R-devel:
  stage: build
  image: rocker/r-devel
  allow_failure: true
  script:
    - rm -rf installed_deps
    - Rscriptdevel -e 'sessionInfo()'
    ## Install missing and outdated packages.
    - Rscriptdevel -e 'source(".gitlab-ci.R"); pkgsUpdate(repos = "https://cran.rstudio.com", quiet = TRUE, instPkgdown = FALSE)'
    - Rscriptdevel -e 'remotes::install_gitlab(repo = "statistical-genetic-pipeline/statgenSSA", host = "git.wur.nl")'
    - Rscriptdevel -e 'install.packages("lattice")'
    ## Remove vignettes folder and get VignetteBuilder field out of DESCRIPTION file.
    - rm -rf vignettes
    - Rscriptdevel -e 'd <- read.dcf("DESCRIPTION"); d[, colnames(d) == "VignetteBuilder"] <- NA; write.dcf(d, "DESCRIPTION")'
    ## Build package.
    - Rdevel CMD build . --no-build-vignettes --no-manual
    - PKG_FILE_NAME=$(ls -1t *.tar.gz | head -n 1)
    - Rdevel CMD check "${PKG_FILE_NAME}" --no-build-vignettes --no-manual --as-cran
  artifacts:
    when: always
    paths:
      - '*.Rcheck/*'
    expire_in: '1 month'

coverage:
  stage: test
  allow_failure: true
  dependencies:
    - R-release
  when: on_success
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - $R_LIBS_USER
      - $CI_PROJECT_DIR/.apt
    policy: pull
  only:
    - develop
    - master
  before_script:
    - echo 'R_LIBS_USER='$R_LIBS_USER > .Renviron
  script:
    - Rscript -e 'covr::package_coverage()'
  coverage: '/Coverage:\s*(\d+.\d+\%)/'

